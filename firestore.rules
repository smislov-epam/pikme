rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Default: deny all reads and writes
    match /{document=**} {
      allow read, write: if false;
    }

    // Users collection: users can read their own document
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      // Writes handled by Cloud Functions only
      allow write: if false;
    }

    // Registration invites: no client access (Admin SDK only)
    match /registrationInvites/{inviteId} {
      allow read, write: if false;
    }

    // Shared games: read-only for authenticated users
    // Writes handled by Cloud Functions (write-once, no overwrites)
    match /games/{gameId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Sessions: hosts and members can read
    match /sessions/{sessionId} {
      // Allow read if user is the creator or a member
      allow read: if request.auth != null && (
        resource.data.createdByUid == request.auth.uid ||
        exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$(request.auth.uid))
      );
      // Writes handled by Cloud Functions only
      allow write: if false;

      // Guest preferences (REQ-103, REQ-108): host-only read.
      // Stored by Cloud Functions (Admin SDK) so clients must never write here.
      match /guestPreferences/{guestPrefId} {
        allow read: if request.auth != null &&
          get(/databases/$(database)/documents/sessions/$(sessionId)).data.createdByUid == request.auth.uid;
        allow write: if false;
      }

      // Session games: same access as parent session
      match /sessionGames/{gameId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/sessions/$(sessionId)).data.createdByUid == request.auth.uid ||
          exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$(request.auth.uid))
        );
        allow write: if false;
      }

      // Participants: same access as parent session
      match /participants/{participantId} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/sessions/$(sessionId)).data.createdByUid == request.auth.uid ||
          exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$(request.auth.uid))
        );
        allow write: if false;
      }

      // Members: same access as parent session
      match /members/{uid} {
        allow read: if request.auth != null && (
          get(/databases/$(database)/documents/sessions/$(sessionId)).data.createdByUid == request.auth.uid ||
          exists(/databases/$(database)/documents/sessions/$(sessionId)/members/$(request.auth.uid))
        );
        allow write: if false;
      }
    }
  }
}
