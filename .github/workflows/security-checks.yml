name: Security & Quality Checks

on:
  push:
    branches: ['**']  # Run on all branches
  pull_request:
    branches: ['**']
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  security-checks:
    name: Security & Quality
    runs-on: ubuntu-latest
    timeout-minutes: 20
    env:
      HUSKY: 0  # Skip husky install in CI

    strategy:
      fail-fast: false
      matrix:
        workspace:
          - name: 'root'
            path: '.'
          - name: 'web'
            path: 'apps/web'
          - name: 'functions'
            path: 'functions'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better security scanning

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'

      # Install dependencies for all workspaces
      - name: Install root dependencies
        run: npm ci
        continue-on-error: false

      - name: Install web dependencies
        working-directory: apps/web
        run: npm ci
        continue-on-error: false

      - name: Install functions dependencies
        working-directory: functions
        run: npm ci
        continue-on-error: false

      # Security Audit
      - name: Security Audit - ${{ matrix.workspace.name }}
        working-directory: ${{ matrix.workspace.path }}
        run: |
          echo "üîí Running security audit for ${{ matrix.workspace.name }}..."
          npm audit --audit-level=moderate
        continue-on-error: false

      # TypeScript Compilation
      - name: TypeScript Build - web
        if: matrix.workspace.name == 'web'
        working-directory: apps/web
        run: |
          echo "üî® Building TypeScript (web)..."
          npm run build
        continue-on-error: false

      - name: TypeScript Build - functions
        if: matrix.workspace.name == 'functions'
        working-directory: functions
        run: |
          echo "üî® Building TypeScript (functions)..."
          npm run build
        continue-on-error: false

      # ESLint
      - name: ESLint - web
        if: matrix.workspace.name == 'web'
        working-directory: apps/web
        run: |
          echo "üîç Running ESLint (web)..."
          npm run lint
        continue-on-error: false

      - name: ESLint - functions
        if: matrix.workspace.name == 'functions'
        working-directory: functions
        run: |
          echo "üîç Running ESLint (functions)..."
          npm run lint
        continue-on-error: false

      # Unit Tests
      - name: Unit Tests - web
        if: matrix.workspace.name == 'web'
        working-directory: apps/web
        run: |
          echo "üß™ Running tests (web)..."
          npm run test
        continue-on-error: false

      - name: Unit Tests - functions
        if: matrix.workspace.name == 'functions'
        working-directory: functions
        run: |
          echo "üß™ Running tests (functions)..."
          npm run test
        continue-on-error: false

  # Secret Detection
  secret-detection:
    name: Secret Detection
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Check for secrets
        run: |
          echo "üîê Scanning for exposed secrets..."
          node tools/detect-secrets.mjs

  # Dependency Review (PRs only)
  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Dependency Review
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: moderate
          deny-licenses: GPL-2.0, GPL-3.0

  # Final status check
  all-checks-passed:
    name: All Security Checks Passed
    runs-on: ubuntu-latest
    needs: [security-checks, secret-detection]
    if: always()

    steps:
      - name: Check if all jobs passed
        run: |
          if [ "${{ needs.security-checks.result }}" != "success" ] || [ "${{ needs.secret-detection.result }}" != "success" ]; then
            echo "‚ùå Security checks failed!"
            exit 1
          fi
          echo "‚úÖ All security checks passed!"
